{
  "basic_intent": {
    "issue_category": "INSTRUMENTATION",
    "static_analysis_query": {
      "find_method_call": "SetTag"
    },
    "semantic_description": "Add HTTP_REFERER and HTTP_RESPONSE_REDIRECT_LOCATION attributes to existing HTTP request spans in the CLM web application.",
    "search_keywords": [
      "HTTP_REFERER",
      "HTTP_RESPONSE_REDIRECT_LOCATION",
      "SetTag",
      "Activity",
      "OpenTelemetry",
      "middleware"
    ],
    "telemetry_operation": {
      "type": "span",
      "target_name": "http-request",
      "action": "ADD_ATTRIBUTES",
      "attributes_to_add": [
        {
          "name": "HTTP_REFERER",
          "value_source": "Request.Headers[\"Referer\"]"
        },
        {
          "name": "HTTP_RESPONSE_REDIRECT_LOCATION",
          "value_source": "Response.Headers[\"Location\"]"
        }
      ],
      "new_span_name": null,
      "new_metric_details": {}
    }
  },
  "enhanced_analysis": {
    "confidence": "high",
    "operation_type": "multi_file",
    "complexity_score": 4,
    "estimated_files": 3,
    "validation_issues": [],
    "suggestions": [],
    "sub_tasks": [
      {
        "order": 1,
        "id": "scope-confirmation",
        "action": "Kick-off & scope review",
        "description": "Review ticket with CLM owners and SRE to confirm environments, attribute names, and security/PII considerations for logging Referer values.",
        "owner": "Telemetry PO",
        "inputs": [
          "This ticket",
          "Security guidelines"
        ],
        "outputs": [
          "Confirmed scope doc"
        ],
        "validation_criteria": "Stakeholders sign-off recorded in Jira"
      },
      {
        "order": 2,
        "id": "code-discovery",
        "action": "Locate existing OpenTelemetry set-up",
        "description": "Search solution for ActivitySource, AddOpenTelemetry(), SetTag, custom ASP.NET middleware.",
        "expected_files": [
          "Startup.cs or Program.cs",
          "OpenTelemetryExtensions.cs",
          "TelemetryMiddleware.cs",
          "ActivityEnrichment.cs"
        ],
        "tools": [
          "grep",
          "VSCode global search",
          "gh code search"
        ],
        "validation_criteria": "Document exact file & line numbers where server Activity is enriched"
      },
      {
        "order": 3,
        "id": "design",
        "action": "Choose enrichment point",
        "description": "Decide where to inject header tags\u2014either: A) existing enrichment delegate (preferred) or B) new middleware added just after UseRouting(). Document decision.",
        "dependencies": [
          "code-discovery"
        ],
        "validation_criteria": "Design doc in /docs/telemetry/redirect-enrichment.md reviewed by senior dev"
      },
      {
        "order": 4,
        "id": "implementation",
        "action": "Add tag logic",
        "description": "In chosen enrichment point:\n  1. Read var referer = context.Request.Headers[\"Referer\"].FirstOrDefault();\n  2. If (!string.IsNullOrWhiteSpace(referer)) activity.SetTag(\"HTTP_REFERER\", referer);\n  3. After next() middleware executes, check status & Location header:\n       if (context.Response.StatusCode is 301,302,303,307,308) {\n           var loc = context.Response.Headers[\"Location\"].FirstOrDefault();\n           if (!string.IsNullOrWhiteSpace(loc)) activity.SetTag(\"HTTP_RESPONSE_REDIRECT_LOCATION\", loc);\n       }\n  4. Guard for null / huge (>2k) values.\n  5. Unit tests for helper class that returns header values.",
        "files_modified": [
          "TelemetryMiddleware.cs (or new RedirectEnrichmentMiddleware.cs)",
          "TelemetryMiddlewareTests.cs"
        ],
        "dependencies": [
          "design"
        ],
        "validation_criteria": "dotnet build & unit tests pass"
      },
      {
        "order": 5,
        "id": "local-verification",
        "action": "Run CLM locally with OTLP exporter pointed to local collector + Jaeger",
        "description": "Trigger normal page and 302 redirect; verify spans contain new attributes in Jaeger UI.",
        "commands": [
          "docker compose up otel-collector jaeger",
          "dotnet run"
        ],
        "validation_criteria": "Both attributes visible on http-server span"
      },
      {
        "order": 6,
        "id": "performance-check",
        "action": "Benchmark request throughput with and without new middleware",
        "description": "Use `wrk` for 1k rps; ensure p95 latency delta < 2 ms.",
        "validation_criteria": "Performance report attached"
      },
      {
        "order": 7,
        "id": "PR",
        "action": "Open Pull Request",
        "description": "Include link to ticket, screenshots of Jaeger traces, unit test coverage, performance report.",
        "validation_criteria": "Approved by 2 reviewers & security sign-off"
      },
      {
        "order": 8,
        "id": "deploy-demo",
        "action": "Deploy to Demo environment",
        "description": "Use standard GitHub Actions pipeline; feature flag behind ENV == Demo initially.",
        "dependencies": [
          "PR"
        ],
        "validation_criteria": "Successful pipeline; attributes visible in Kusto using provided query"
      },
      {
        "order": 9,
        "id": "rollout-all",
        "action": "Gradual rollout to Test \u2192 Prod",
        "description": "Toggle feature flag per environment after 24 h observation; monitor SLO dashboards for error-rate or size spikes.",
        "validation_criteria": "No regression, attributes present in >95 % of spans"
      },
      {
        "order": 10,
        "id": "documentation",
        "action": "Update runbooks & observability docs",
        "description": "Add section on new span attributes and sample Kusto queries.",
        "validation_criteria": "Docs merged; link posted in #clm-observability"
      },
      {
        "order": 11,
        "id": "close-ticket",
        "action": "Final verification & ticket closure",
        "description": "Confirm acceptance criteria checklist, attach final Kusto screenshot, close ticket.",
        "validation_criteria": "Ticket moved to Done"
      }
    ],
    "contextual_hints": [
      "Capturing the final response headers (Location) after the framework sets them and before the Activity is stopped",
      "Ensuring attributes are added only to the main HTTP server span and not to child/internal spans"
    ]
  }
}